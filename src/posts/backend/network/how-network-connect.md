---
icon: laptop-file
date: 2025-01-04
category:
  - 计算机网络
# tag:
footer: 凉了的馒头
---

# 网络是怎样连接的

---



### 第 1 章 浏览器生成消息——探索浏览器内部

1. 生成 HTTP Request

   - $\underbrace{http:}_{\text{协议}}//\underbrace{www.google.com}_{\text{域名}}\underbrace{/dir1/index.html}_{\text{文件名}}$

   - $http://www.google.com$ 

     - 访问根目录下的默认文件

   - $http://www.google.com/$

     - 访问根目录，因为没有文件名，也就是访问默认文件。

   - 至于 HTTP Request/Response，其有固定的格式。

   - 方法：**GET/POST**

     - 如果有代理，GET 的 URL 是全称 

     - **参见 Catbook** GET/POST 的行为是由后端 API 定义的，所以很多地方用二者都可以。

     - 当然，二者的行为不一样，这是规范所定义的。GET 会将参数放在 url 中，POST 会放在 body 中。

       同时 POST 能携带更多的 Payload。

     - 显然，二者都不安全。真正的安全只能靠加密。

   - 响应码：2xx 成功 401 权限 404 NotFound 5xx服务器错误

2. 向 DNS Server 查询域名 IP

   - 主机号全0 整个子网 全1 广播

   - 域名方便人用，IP地址方便路由器用。根据域名查IP：DNS

   - DNS客户端又称DNS解析器，包含在**OS的Socket库**中。

     - 浏览器会调用解析器来根据域名查询 IP
     - 解析器内部原理：浏览器`gethostbyname`->Socket`发送DNS查询`->OS协议栈`发送UDP`->网卡->DNS服务器
     - 对于DNS Server的IP，一般都事先设置好了

     <img src="/assets/posts/net-Ref/1.png" style="zoom:60%;" />

3. 全世界 DNS Server 大接力

   <img src="/assets/posts/net-Ref/2.png" style="zoom:67%;" />

   - 域名的层次结构：由 . 分隔

   - 一个域不能拆分到多个Server存，然而一个Server可以存多个域的信息

   - $www.google.com.$ 最后的点代表根域。全世界有十三个根域服务器，它们被提前配置在DNS服务器config里。
     - DNS 依次从根域出发，根域返回 com 域的DNS IP。再去查询 com 域，寻找到 google DNS服务器 IP，再去查询 www 域获得最终IP
     - 现实中两个域可以共享一个DNS 服务器
     - **DNS服务器**有缓存功能，其缓存的信息都有有效期

4. 委托协议栈发送信息

   - 关键是都是由OS协议栈完成

   - 协议栈创建套接字

   - IP+Port 套接字连接到服务器
   - 收发数据
   - 断开管道并删除套接字



---

### 第2章 用电信号传输 TCP/IP 数据——探索协议栈 和网卡

1. 创建套接字

   <img src="/assets/posts/net-Ref/3.png" style="zoom:67%;" />

   - 套接字的实体就是通信控制信息(就是一个对象)

     > 在协议栈内部有一块用于存放控制信息的内存空间，这里记录了用于控制通信操作的控制信息，例如通信对象的 IP 地址、端口号、通信操作的进行状态等。本来套接字就只是一个概念而已，并不存在实体，如果一定要赋予它一个实体，我们可以说这些控制信息就是套接字的实体。

   - Windows `netstat -ano` 每一行就是一个套接字

     - `TCP    10.192.119.55:59569    103.28.54.181:27023    ESTABLISHED     18388`
     - TCP 本地的 10.192.119.55:59569 连接到远程到的 103... PID 为 18388

   - 套接字的存在就是给协议栈提供通信信息

2. 连接服务器(Pass)

3. 收发数据(TCP Pass)

4. 从服务器断开并删除套接字(Pass)

5. IP与以太网的包收发操作

   <img src="/assets/posts/net-Ref/4.png" style="zoom:67%;" />

   - IP 协议根据目标地址判断下一个 IP 转发设备的位置(路由器)

   - 子网中的以太网协议将包传输到下一个转发设备(集线器)

   - 流程：

     - TCP模块添加TCP头部并指定IP地址，IP模块添加MAC头部和IP头部
     - 封装好的包会被交给网卡(e.g. 以太网，无线局域网)。包是由0和1组成的数字信息，网卡会将这些数字信息转换为电信号或光信号通过网线(光纤)发送出去
     - 这些最后到达集线器，路由器等转发设备，最后一步步到达目的地。

   - 路由表：`route print`

   - ARP

     - 局域网内广播查 MAC
     - 只要不出错都能查到。默认网关的MAC应该用的最多。
     - ARP缓存 `arp -a`

   - 以太网的结构

     <img src="/assets/posts/net-Ref/5.png" style="zoom:67%;" />

     - 交换式集线器：交换机。不同于集线器的广播发送，交换机可以实现点对点发送。
     - 集线器半双工，可能发生碰撞，早已被淘汰

   - 网卡和网卡驱动(内置于OS)一起将数字信号转换成电信号

   - 网卡在拿到包后还会在头部加入报头，尾部加入检测错误的检验序列。

     - 报头就是一串01序列，用于检测信号周期

   - 接收返回包

     - 依靠中断
     - 如果发现包的接收方IP不是本机IP，发送ICMP
     - IP模块可能会处理分片
     - TCP模块将数据放入缓存区等待应用程序读取

6. UDP

   - 适合发短数据的信息
   - 适合音视频信息，允许一定的失真
   - UDP 可能被防火墙阻止。厂商这时可以采用TCP传输



---

### 第 3 章 从网线到网络设备——探索集线器、交换机 和路由器

- 本章是我看这本书的主要目的，补足以前不知道的一些硬件的细节。

1. 信号在网线和集线器中传输

   <img src="/assets/posts/net-Ref/6.png" style="zoom:67%;" />

   - 家庭路由器已经集成了了集线器和交换机的功能。
   - 集线器通过广播发送信息

2. **交换机的包转发操作**

   <img src="/assets/posts/net-Ref/7.png" style="zoom:67%;" />

   - 交换机根据地址表进行转发

     - 信号由双绞线传送到达网线接口，由PHY接收(这部分与集线器相同)。接下来PHY模块将信号转换为通用格式，传递给MAC模块。MAC模块将信号转换为数字信号。如果通过包尾的检验则放到缓冲区。这部分操作和网 卡基本相同，大家可以认为交换机的每个网线接口后面都是一块网卡。

       > 网卡本身具有 MAC 地址，并通过核对收到的包的接收方 MAC 地址判断是不是发给自己的，如果不是发给自己的则丢弃；相对地，交换机的端口不核对接收方 MAC 地址，而是直接接收所有的包并存放到缓冲区中。因此，和网卡不同，交换机的端口不具有 MAC 地址。

   - 交换机地址表的维护

     - > 第一种是收到包时，将发送方 MAC 地址以及其输入端口的号码写入 MAC 地址表中。由于收到包的那个端 口就连接着发送这个包的设备，所以只要将这个包的发送方 MAC 地址写入地址表，以后当收到发往这个地 址的包时，交换机就可以将它转发到正确的端口了。交换机每次收到包时都会执行这个操作，因此只要某个 设备发送过网络包，它的 MAC 地址就会被记录到地址表中

     - > 另一种是删除地址表中某条记录的操作，这是为了防止设备移动时产生问题。比如，我们在开会时会把笔记 本电脑从办公桌拿到会议室，这时设备就发生了移动。从交换机的角度来看，就是本来连接在某个端口上的 笔记本电脑消失了。

     - 交换机几分钟会删除**未被使用的记录**。如果仍然转发给老的端口也可以通过重启来清空地址表。

     - 如果表中找不到MAC地址也很简单，直接进行广播即可。此时收到响应信息后再将对应的MAC地址写入表中。

     - 此外如果接收方地址就是广播地址，那也直接进行广播。

   - 全双工，同时发送接收

   - 有多个端口可以同时执行多个转发操作

   - **可以上拼多多查看交换机商品的具体信息** 有位同学就购买了一台交换机实现了局域网内的多人联机，打游戏不卡。

3. **路由器的包转发操作**

   <img src="/assets/posts/net-Ref/8.png" style="zoom:67%;" />

   - 路由器的各个端口都具有MAC地址和IP地址

   - 路由器信息：`route print`

     | 网络目标  | 网络掩码  | 网关       | 接口          | 跃点数 |
     | --------- | --------- | ---------- | ------------- | ------ |
     | 224.0.0.0 | 240.0.0.0 | 在链路上   | 127.0.0.1     | 331    |
     | 0.0.0.0   | 0.0.0.0   | 10.192.0.1 | 10.192.119.55 | 35     |

     - 其中 10.192.119.55 对应 ipconfig 中 无线局域网适配器 WLAN 的IP

     - > GPT: 224.0.0.0/4表示一个多播地址，它是为进行多播通信而保留的地址范围。在大多数情况下，多播地址并不直接用于常规的主机通信，而是用于多播组通信。
       >
       > 127.0.0.1是本地回环地址，通常用于本地主机内部的自我通信。通过这条路由，表示任何发往多播地址224.0.0.0的数据包都将在本地主机内部进行处理，不会被发送到外部网络。

     - 路由器会忽略主机号，只匹配网络号。

   - 路由器的包接收操作：因为端口有MAC地址所以基本一样，如果不是发给自己的就丢弃(以太网规则)。否则就进行转发

   - 路由器根据最长匹配寻找网络号，如果找不到就丢弃。不过实际中一般会有 0.0.0.0 这个默认路由，将包转发到对应的默认网关(网关这里就是路由器，上面的 10.192.119.55)

   - 路由器对包的发送取决于端口类型。如果是以太网端口，则按照以太网的规则将包转换为电信号发送出去； 如果是 ADSL 则按照 ADSL 的规则来转换。

   - > 首先，为了判断 MAC 头部中的 MAC 地址应该填写什么值，我们需要根据路由表的网关列判断对方的地址。如果网关是一个 IP 地址，则这个 IP 地址就是我们要转发到的目标地址；如果网关为空，则 IP 头部中的接收方 IP 地址就是要转发到的目标地址。知道对方的 IP 地址之后，接下来需要通过 ARP 根据 IP 地址查询 MAC 地址，并将查询的结果作为接收方 MAC 地址。路由器也有 ARP 缓存，因此首先会在 ARP 缓存中查询，如果找不到则发送 ARP 查询请求。

   - **路由器与交换机的关系**

     - IP 本身不负责包的传输，而是委托各种通信技术将包传输到下一个路由器。
     - IP（路由器）负责将包送达通信对象这一整体过程，而其中将包传输到下一个路由器的过程则是由以太网（交换机）来负责的。

4. **路由器的附加功能**

   - NAT：私有地址转换

     - 10.0.0.0 ～ 10.255.255.255 
     - 172.16.0.0 ～ 172.31.255.255 
     - 192.168.0.0 ～ 192.168.255.255

     ![](/assets/posts/net-Ref/9.png)

     - > 有时候我们希望能够从互联网访问公司内网，这需要进行一些设置才能实现。之所以无法从互联网访问内网，是因为对应表里没有相应的记录，那么我们只要事先手动添加这样的记录就可以了（图 3.19）。一般来说，用于外网访问的服务器可以放在地址转换设备的外面并为它分配一个公有地址，也可以将服务器的私	有地址手动添加到地址转换设备中，这样就可以从互联网访问到这台具有私有地址的服务器了 。

   - 包过滤

     - > 包过滤就是在对包进行转发时，根据 MAC 头部、IP 头部、TCP 头部的内容，按照事先设置好的规则决定是转发这个包，还是丢弃这个包。我们通常说的防火墙设备或软件，大多数都是利用这一机制来防止非法入侵的。

     - 这个规则很难制定。



---

### 第 4 章 通过接入网进入互联网内部——探索接入网 和网络运营商

1. ADSL接入网的结构和工作方式

   - 互联网的基本结构跟家庭网络，公司网络是相同的
   - 不同的地方在于：
     - 距离的不同，转发设备之间可能间隔几公里，而家庭，公司网络间不足几百米(双绞线极限距离100米)
     - 路由维护方式的不同，路由记录更多且在不断变化
   - ADSL已经被淘汰所以 PASS

2. 光纤接入网(FTTH: fiber to the home)

   - 光纤通过光信号传递信息(全反射)

   - 用光纤来代替 ADSL 将用户端接入路由器和运营商的 BAS 连接起来的接入方式就是 FTTH

   - > BAS：Broadband Access Server，宽带接入服务器。它也是一种路由器。
     >
     > PPP：Point-to-Point Protocol，点到点协议。它是电话线、ISDN 等通信线路所使用的一种协议，集成了用户认证、配置下发、数据压缩、加密等各种功能。

   - > GPT: 数据在光纤网络中传输到用户家里的光猫（用于光纤信号转换），然后连接到家里的路由器，路由器再通过光纤或其他连接形式将数据传输回运营商的BAS。BAS是运营商提供互联网连接的关键设备，负责管理用户接入、数据传输和互联网连接。
     >
     > 光猫通常用于将光纤信号转换为适合路由器使用的信号，但在某些情况下，**运营商会在网络接入点进行信号转换，直接提供给用户可以直接连接的信号。**这样用户就可以直接通过网线将网络信号接入到自己的路由器或者设备上，不需要借助光猫来进行信号转换。(FTTB: fiber to the building)

   - 关于[光猫](https://www.zhihu.com/question/516198232/answer/2375278725)

   - 

3. 接入网中使用的PPP和隧道

4. 网络运营商的内部

5. 跨越运营商的网络包
